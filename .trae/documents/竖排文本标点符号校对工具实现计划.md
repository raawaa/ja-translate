# 竖排文本标点符号校对工具实现计划

## 功能需求

1. 分析translated目录中的书籍文本内容，自动判断其排版方向是否为竖排格式
2. 若判定为竖排格式，对文本中的标点符号进行系统性校对
3. 识别并修正所有不符合竖排排版规范的标点符号，确保其符合中文竖排文本的标点使用标准
4. 直接替换translated目录中的原文件，并生成校对报告，记录修改的标点符号位置及类型

## 实现方案

### 1. 脚本结构设计

创建一个名为 `vertical_text_proofreader.py` 的Python脚本，包含以下主要模块：

* `VerticalTextProofreader` 类：核心校对工具类
  * `__init__()`：初始化校对工具，设置默认参数
  * `is_vertical_text()`：判断文本是否为竖排格式
  * `proofread_punctuation()`：校对标点符号
  * `generate_report()`：生成校对报告
  * `process_html_file()`：处理单个HTML/XHTML文件
  * `process_directory()`：处理translated目录中的所有文件

* `main()` 函数：命令行接口，简化参数设计

### 2. 竖排文本检测算法

使用以下方法检测竖排文本：

* **HTML属性检测**：检查HTML文件中的 `dir` 属性和 `writing-mode` CSS样式
* **CSS样式检测**：搜索CSS文件或HTML中的style标签，查找竖排相关样式
* **文本特征检测**：统计竖排专用标点符号比例、平均每行长度、竖排引号数量等

### 3. 标点符号映射规则

创建横排到竖排标点符号的映射表：

```python
horizontal_to_vertical_punctuation = {
    # 基本标点
    '，': '、',  # 逗号转顿号
    '。': '。',  # 句号保持不变
    '！': '！',  # 感叹号保持不变
    '？': '？',  # 问号保持不变
    
    # 引号
    '“': '「',  # 左双引号
    '”': '」',  # 右双引号
    '‘': '『',  # 左单引号
    '’': '』',  # 右单引号
    
    # 括号
    '（': '︵',  # 左圆括号
    '）': '︶',  # 右圆括号
    '【': '︻',  # 左方括号
    '】': '︼',  # 右方括号
    '《': '︽',  # 左书名号
    '》': '︾',  # 右书名号
    
    # 其他符号
    '——': '—',  # 破折号简化
    '……': '…',  # 省略号简化
}
```

### 4. 校对报告生成

校对报告包含以下内容：

* 报告标题和分隔线
* 处理的文件数和总修改数
* 修改详情表：文件路径、位置、原字符、修正后字符、类型
* 统计信息：修改率等

### 5. 输入输出处理

* 默认处理当前目录下的 `translated` 目录
* 直接替换原HTML/XHTML文件
* 在校对报告中记录所有修改
* 命令行参数简化：
  * `--report-only`：只生成报告，不修改原文件（可选）
  * `--verbose`：显示详细的处理过程（可选）

## 技术实现细节

### 1. 竖排检测具体实现

```python
def is_vertical_text(self, html_content: str) -> bool:
    import re
    # 检查HTML属性和CSS样式
    vertical_indicators = [
        r'writing-mode:\s*(vertical-rl|tb-rl)',
        r'dir\s*=\s*["\']rtl["\']',
        r'text-orientation:\s*upright',
        r'-webkit-writing-mode:\s*(vertical-rl|tb-rl)',
        r'-moz-writing-mode:\s*(vertical-rl|tb-rl)'
    ]
    
    for indicator in vertical_indicators:
        if re.search(indicator, html_content, re.IGNORECASE):
            return True
    
    # 检查文本特征
    # ...（如前所述的文本特征检测）
    
    return False
```

### 2. HTML处理实现

使用BeautifulSoup库来处理HTML文件，确保只修改文本内容，不破坏HTML结构：

```python
def process_html_file(self, file_path: str) -> int:
    from bs4 import BeautifulSoup
    
    # 读取文件
    with open(file_path, 'r', encoding='utf-8') as f:
        html_content = f.read()
    
    # 判断是否为竖排文本
    if not self.is_vertical_text(html_content):
        if self.verbose:
            print(f"✗ {file_path}: 未检测到竖排文本，跳过")
        return 0
    
    # 解析HTML
    soup = BeautifulSoup(html_content, 'html.parser')
    
    # 遍历所有文本节点
    changes = 0
    for text_node in soup.find_all(text=True):
        if text_node.parent.name not in ['script', 'style', 'meta', 'link', 'title']:
            original_text = text_node.string
            if original_text:
                corrected_text = self.proofread_punctuation(original_text)
                if corrected_text != original_text:
                    text_node.string = corrected_text
                    changes += 1
    
    # 写入修改后的内容
    if changes > 0 and not self.report_only:
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(str(soup))
    
    if self.verbose:
        print(f"✓ {file_path}: 修改了 {changes} 处标点符号")
    
    return changes
```

### 3. 目录处理实现

```python
def process_directory(self, dir_path: str) -> Tuple[int, int]:
    import os
    
    total_files = 0
    total_changes = 0
    
    # 遍历目录中的所有文件
    for root, dirs, files in os.walk(dir_path):
        for file in files:
            if file.endswith(('.html', '.xhtml', '.htm')):
                file_path = os.path.join(root, file)
                total_files += 1
                changes = self.process_html_file(file_path)
                total_changes += changes
    
    return total_files, total_changes
```

## 使用示例

```bash
# 基本使用：直接处理translated目录，替换原文件
python vertical_text_proofreader.py

# 只生成报告，不修改原文件
python vertical_text_proofreader.py --report-only

# 显示详细处理过程
python vertical_text_proofreader.py --verbose

# 显示详细处理过程且只生成报告
python vertical_text_proofreader.py --verbose --report-only
```

## 预期输出

1. 控制台输出（基本模式）：

   ```
   正在处理目录: translated
   ✓ 处理完成！
   总计处理了 10 个文件，修改了 125 处标点符号
   ✓ 校对报告已生成: proofread_report.txt
   ```

2. 控制台输出（详细模式）：

   ```
   正在处理目录: translated
   ✓ translated/OEBPS/chapter1.xhtml: 修改了 15 处标点符号
   ✗ translated/OEBPS/chapter2.xhtml: 未检测到竖排文本，跳过
   ✓ translated/OEBPS/chapter3.xhtml: 修改了 20 处标点符号
   ...
   ✓ 处理完成！
   总计处理了 10 个文件，修改了 125 处标点符号
   ✓ 校对报告已生成: proofread_report.txt
   ```

3. 校对报告示例：

   ```
   ==================================================-
   竖排文本标点符号校对报告
   ==================================================
   日期: 2025-12-19 14:30:00
   总文件数: 10
   总修改数: 125
   修改率: 0.35%

   修改详情:
   ------------------------------
   文件路径 | 位置  | 原字符 | 修正后 | 类型
   ------------------------------
   translated/OEBPS/chapter1.xhtml |  123 |   ，   |   、   | 标点符号转换
   translated/OEBPS/chapter1.xhtml |  456 |   “   |   「   | 标点符号转换
   translated/OEBPS/chapter3.xhtml |  789 |   」   |   」   | 标点符号转换
   ...
   ```

## 实现步骤

1. 创建 `vertical_text_proofreader.py` 脚本文件
2. 实现 `VerticalTextProofreader` 类的各个方法
3. 实现 `main()` 函数，处理命令行参数
4. 测试脚本功能
5. 优化和完善

## 依赖说明

* Python 3.8+
* BeautifulSoup4：用于HTML解析（项目已依赖）
* 项目已有的依赖包（无需额外安装）

## 集成到现有工作流

该脚本可以作为EPUB翻译工作流的一部分，在翻译完成后运行，确保竖排文本的标点符号符合规范。